<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <%= article && article._id ? 'Ngày lễ' : 'Bài Viết/Suy Niệm Mới' %>
                        <% let headerNgayLeTitle = '';
                           if (typeof search !== 'undefined' && search && search.ngay_le_title) headerNgayLeTitle = search.ngay_le_title;
                           else if (typeof ngayLe !== 'undefined' && ngayLe && ngayLe.title) headerNgayLeTitle = ngayLe.title;
                           else if (article && article.ngay_le_title) headerNgayLeTitle = article.ngay_le_title;
                        %>
                        <% if (headerNgayLeTitle && headerNgayLeTitle.length) { %> — <%= headerNgayLeTitle %><% } %>
                    </h5>
                    <a href="/bien-tap-suy-niem" class="btn btn-sm btn-light">
                        <i class="bi bi-x"></i> Back
                    </a>
                </div>
                <div class="card-body">
                    <form id="article-form">
                        <input type="hidden" id="article-id" value="<%= article && article._id ? article._id : '' %>">
                        <% if (search && search.ngay_le_id) { %>
                            <input type="hidden" id="ngay-le-id" value="<%= search.ngay_le_id %>">
                        <% } else { %>
                            <div class="mb-3">
                                <label for="ngay-le-id" class="form-label"><strong>Belongs to Ngay-le</strong></label>
                                <select id="ngay-le-id" class="form-select">
                                    <option value="">-- Select Ngay-le --</option>
                                    <% if (typeof ngayLeList !== 'undefined' && ngayLeList.length) { %>
                                        <% ngayLeList.forEach(function(nl) { %>
                                            <option value="<%= nl._id %>" <%= article && article.ngay_le_id && (String(article.ngay_le_id) === String(nl._id)) ? 'selected' : '' %>><%= nl.title %></option>
                                        <% }) %>
                                    <% } %>
                                </select>
                            </div>
                        <% } %>
                        
                        <!-- Title Input -->
                        <div class="mb-3">
                            <label for="article-title" class="form-label"><strong>Article Title</strong></label>
                            <input type="text" class="form-control" id="article-title" placeholder="Enter article title" 
                                value="<%= article && article.title ? article.title : '' %>" required>
                        </div>

                        <!-- Author Input -->
                        <div class="mb-3">
                            <label for="article-author" class="form-label"><strong>Author</strong></label>
                            <input type="text" class="form-control" id="article-author" placeholder="Enter author name"
                                value="<%= article && article.author ? article.author : '' %>" required>
                        </div>

                        <!-- Content Input with Rich Text Editor -->
                        <div class="mb-3">
                            <label for="article-content" class="form-label"><strong>Content</strong></label>
                            <div id="editor-toolbar" class="mb-2 btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="bold-btn" title="Bold">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="italic-btn" title="Italic">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="underline-btn" title="Underline">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="heading-btn" title="Heading">
                                        <i class="bi bi-type-h2"></i>
                                    </button>
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="ul-btn" title="Bullet List">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="ol-btn" title="Numbered List">
                                    <i class="bi bi-list-ol"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="link-btn" title="Insert Link">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <input type="color" id="text-color-btn" class="btn btn-outline-secondary btn-sm" title="Change Text Color" style="width: 40px; height: 38px; padding: 2px; cursor: pointer; border: 1px solid #6c757d;">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-btn" title="Clear Formatting">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="view-toggle-btn" title="Toggle HTML/Text View">
                                    <i class="bi bi-code"></i>
                                </button>
                            </div>
                            <div id="article-content" class="form-control editor-view" style="min-height: 400px; resize: vertical; padding: 10px; overflow-y: auto;" 
                                contenteditable="true"><%- article && article.content ? article.content : '' %></div>
                            <textarea id="article-content-html" class="form-control editor-view d-none" style="min-height: 400px; resize: vertical; padding: 10px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9rem;" aria-label="HTML source"><%- article && article.content ? article.content : '' %></textarea>
                        </div>

                        <!-- Success/Error Messages -->
                        <div class="alert alert-success alert-dismissible fade show d-none" id="success-alert" role="alert">
                            Article saved successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show d-none" id="error-alert" role="alert">
                            <span id="error-message">An error occurred while saving the article.</span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="/bien-tap-suy-niem" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> Save Article
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    
    // Rich text editor functions
    function execCommand(command, value = null) {
        document.execCommand(command, false, value);
        $('#article-content').focus();
    }

    // Toolbar button handlers
    $('#bold-btn').click(function(e) {
        e.preventDefault();
        execCommand('bold');
    });

    $('#italic-btn').click(function(e) {
        e.preventDefault();
        execCommand('italic');
    });

    $('#underline-btn').click(function(e) {
        e.preventDefault();
        execCommand('underline');
    });

    $('#heading-btn').click(function(e) {
        e.preventDefault();
        execCommand('formatBlock', '<h2>');
    });

    $('#ul-btn').click(function(e) {
        e.preventDefault();
        execCommand('insertUnorderedList');
    });

    $('#ol-btn').click(function(e) {
        e.preventDefault();
        execCommand('insertOrderedList');
    });

    $('#link-btn').click(function(e) {
        e.preventDefault();
        const url = prompt('Enter the URL:');
        if(url) {
            execCommand('createLink', url);
        }
    });

    $('#text-color-btn').on('change', function(e) {
        const color = $(this).val();
        execCommand('foreColor', color);
    });

    $('#clear-btn').click(function(e) {
        e.preventDefault();
        execCommand('removeFormat');
    });

    // Toggle between HTML and text view
    let isHtmlView = false;

    function setToolbarDisabled(disabled) {
        $('#editor-toolbar').find('button, input').not('#view-toggle-btn').prop('disabled', disabled);
        if(disabled) {
            $('#editor-toolbar').find('button, input').not('#view-toggle-btn').addClass('disabled');
        } else {
            $('#editor-toolbar').find('button, input').not('#view-toggle-btn').removeClass('disabled');
        }
    }

    $('#view-toggle-btn').click(function(e) {
        e.preventDefault();
        isHtmlView = !isHtmlView;
        
        if(isHtmlView) {
            // Switch to HTML view: copy raw HTML into textarea and disable toolbar
            const htmlContent = $('#article-content').html();
            $('#article-content-html').val(htmlContent);
            $('#article-content').addClass('d-none');
            $('#article-content-html').removeClass('d-none');
            $('#article-content-html').focus();
            $(this).addClass('active');
            setToolbarDisabled(true);
        } else {
            // Switch back to visual view: set HTML and enable toolbar
            const textContent = $('#article-content-html').val();
            $('#article-content').html(textContent);
            $('#article-content-html').addClass('d-none');
            $('#article-content').removeClass('d-none');
            $('#article-content').focus();
            $(this).removeClass('active');
            setToolbarDisabled(false);
        }
    });

    // Ensure toolbar enabled by default
    setToolbarDisabled(false);

    // Form submission
    $('#article-form').on('submit', function(e) {
        e.preventDefault();

        const articleId = $('#article-id').val();
        const title = $('#article-title').val().trim();
        const author = $('#article-author').val().trim();
        let content;
        
        // Get content from whichever view is currently active
        if(isHtmlView) {
            content = $('#article-content-html').val();
        } else {
            content = $('#article-content').html();
        }

        // Validation
        if(!title || !author || !content.trim()) {
            $('#error-alert').removeClass('d-none');
            $('#error-message').text('Please fill in all required fields.');
            return;
        }

        const ngayLeId = $('#ngay-le-id').val();
        const payload = {
            title: title,
            author: author,
            content: content,
            _id: articleId || undefined,
            ngay_le_id: ngayLeId || undefined
        };
        console.log('Payload:', payload);
        // Send to server
        $.ajax({
            url: '/save-article',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function(response) {
                $('#success-alert').removeClass('d-none');
                $('#error-alert').addClass('d-none');
                setTimeout(function() {
                    window.location.href = '/bien-tap-suy-niem';
                }, 1500);
            },
            error: function(err) {
                $('#error-alert').removeClass('d-none');
                $('#success-alert').addClass('d-none');
                $('#error-message').text('Failed to save article. Please try again.');
                console.error('Error:', err);
            }
        });
    });

    // Focus editor on load
    $('#article-content').focus();
});
</script>

<style>
    #article-content {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        line-height: 1.5;
    }

    #article-content:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .btn-outline-secondary.btn-sm {
        padding: 0.375rem 0.5rem;
        font-size: 0.85rem;
    }

    #article-content-html {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
    }

    #article-content-html:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #view-toggle-btn.active {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }

    #article-content-html {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background-color: #fff;
    }

    #article-content-html:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #view-toggle-btn.active {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }
</style>
